<style>
    #displayWindow{
        border:1px solid #999;
    }
</style>

<script type="text/javascript">
    const Game = function(){
        this.windowScale = 5;
        this.gameWidth = 800;
        this.gameHeight = 600;
        this.speed = 250;
        this.gameWindow = "";
        this.continuous = true;

        var cells = [];
        var r = Math.floor(Math.random() * 254);
        var g = Math.floor(Math.random() * 254);
        var b = Math.floor(Math.random() * 254);
        var iteration = 0;
        var colorIteration;
        var processing = 0;
        var currentCells;

        this.initialize = function(){
            this.gameWindow = document.getElementById("displayWindow");
            this.gameWindow.setAttribute("width", this.gameWidth);
            this.gameWindow.setAttribute("height", this.gameHeight);
            this.gameColumns = Math.round(this.gameWidth / this.windowScale);
            this.gameRows = Math.round(this.gameHeight / this.windowScale);

            this.colorFn = colorCellsCycle;

            // set initial cell states
            const emptyColumn = Array(this.gameRows).fill(false);
            cells = Array(this.gameColumns)
                .fill(false)
                .map(() => [...emptyColumn]);
        };

        this.seedRandomly = function(){
            cells = cells.map(outer => outer.map(() => Math.random() < 0.5));
            this.redraw();
        };

        this.activateCellViaMouse = function(evt){
            var canvasPosition = this.gameWindow.getBoundingClientRect();
            var mouseX = evt.clientX - canvasPosition.left;
            var mouseY = evt.clientY - canvasPosition.top;

            var xPos = (mouseX - (mouseX % this.windowScale))/this.windowScale;
            var yPos = (mouseY - (mouseY % this.windowScale))/this.windowScale;
            if ((evt.type === "click" && evt.button === 0) || (evt.type === "mousemove" && evt.buttons > 0)) {
                this.toggleCell(xPos, yPos);
            }
        };

        this.loop = function(){
            if(!processing) {
                processing = 1;
                iteration++;
                currentCells = 0;
                currentCells = cloneCellArray(cells);
                processCells();
                this.redraw();
                processing = 0;

                if(this.continuous){
                    window.setTimeout(function(obj){obj.loop()},this.speed, this);
                }
            }
        };

        this.start = function(){
            this.continuous = true;
            this.loop();
        };

        this.step = function(){
            this.continuous = false;
            this.loop();
        };


        this.redraw = function(){
            var currentContext = this.gameWindow.getContext("2d");
            // Clear canvas
            currentContext.clearRect(0, 0, this.gameWindow.width, this.gameWindow.height);

            // Redraw all active cells
            cells.forEach((row, x) => row.forEach((cell, y) => this.drawCell(x, y, cell)));
        };

        this.toggleCell = function(xPos,yPos){
            cells[xPos][yPos] = !cells[xPos][yPos];
            this.drawCell(xPos, yPos, cells[xPos][yPos]);
        };

        this.drawCell = function(xPos, yPos, alive){
            var currentContext = this.gameWindow.getContext("2d");
            var actualX = xPos * this.windowScale;
            var actualY = yPos * this.windowScale;

            currentContext.fillStyle = alive ? this.colorFn() : "rgb(255, 255, 255)";
            currentContext.fillRect(actualX, actualY, this.windowScale, this.windowScale);
        };

        var processCells = function(){
            for(var x = 0; x < currentCells.length; x++){
                for(var y = 0; y < currentCells[x].length; y++){
                    var liveNeighbors = 0;
                    for(var offsetX = -1; offsetX < 2; offsetX++){
                        for(var offsetY = -1; offsetY < 2; offsetY++){
                            var neighborX = x + offsetX;
                            var neighborY = y + offsetY;
                            if(neighborX == x && neighborY == y ){
                                // console.log("--> skipping ["+offsetX+"]["+offsetY+"]");
                            }else{
                                if(currentCells[neighborX] && currentCells[neighborX][neighborY]) {
                                    liveNeighbors++;
                                }
                            }
                        }
                    }
                    applyRules(x, y, liveNeighbors);
                }
            }
        };

        var cloneCellArray = function(cellArray){
            return cellArray.map(c => [...c]);
        };

        var applyRules = function(xPos, yPos, neighborCount){
            var currentCellState = cells[xPos][yPos];
            if(currentCellState === false && neighborCount === 3){
                cells[xPos][yPos] = true;
                return;
            }
            if(currentCellState === true && (neighborCount === 2 || neighborCount === 3)){
                return;
            }
            cells[xPos][yPos] = false;
        };

        var colorCellsRandomly = function(){
            var r = Math.floor(Math.random() * 254);
            var g = Math.floor(Math.random() * 254);
            var b = Math.floor(Math.random() * 254);

            return `rgb(${r}, ${g}, ${b})`;
        };

        var colorCellsCycle = function(){
            if(colorIteration != iteration){
                colorIteration = iteration;
                colorArray = [r, g, b];
                colorArray = colorArray.map(c => {
                    const newColor = c + (Math.floor(Math.random() * 3) - 1) * Math.floor(Math.random() * 10);
                    return Math.min(Math.max(newColor, 1), 254);
                });
                [r, g, b] = colorArray;
            }
            return `rgb(${r}, ${g}, ${b})`;
        };
    }

    const gameObj = new Game;

    window.onload = () => {
        gameObj.initialize();
        gameObj.gameWindow.addEventListener("click", function(evt){gameObj.activateCellViaMouse(evt)}, false);
        gameObj.gameWindow.addEventListener("mousemove", function(evt){gameObj.activateCellViaMouse(evt)}, false);
    };
</script>

<html>
<body>
    <div>
        <input type="button" value="Start" onClick="gameObj.start()">
        <input type="button" value="Stop" onClick="gameObj.continuous = false">
        <input type="button" value="Step" onClick="gameObj.step()">
        <input type="button" value="seed randomly" onClick="gameObj.seedRandomly()">
    </div>

    <canvas id="displayWindow"></canvas>
</body>
</html>
